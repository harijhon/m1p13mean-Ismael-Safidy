<p-toast></p-toast>

<p-toolbar styleClass="mb-4">
  <div class="flex flex-wrap items-center justify-between gap-4" pToolbarLeft>
    <div class="flex gap-2">
      <button pButton label="Nouveau" icon="pi pi-plus" class="p-button-success mr-2" (click)="openNew()"></button>
      <button pButton label="Supprimer" icon="pi pi-trash" class="p-button-outlined p-button-secondary"
              [disabled]="!selectedUsers || !selectedUsers.length" (click)="deleteSelectedUsers()"></button>
    </div>
  </div>
  <div class="flex gap-2" pToolbarRight>
    <button pButton label="Export" icon="pi pi-upload" class="p-button-secondary"></button>
  </div>
</p-toolbar>

<p-table #dt [value]="users" [loading]="isLoading" responsiveLayout="scroll" [rows]="10" [paginator]="true"
         [globalFilterFields]="['name','email']" selectionMode="multiple" [(selection)]="selectedUsers"
         styleClass="p-datatable-gridlines">
  <ng-template pTemplate="caption">
    <div class="flex items-center justify-between">
      <h5 class="m-0">Gestion des Utilisateurs</h5>
      <p-iconfield class="p-iconfield p-iconfield-left">
        <p-inputicon styleClass="pi pi-search" />
        <input pInputText placeholder="Rechercher..." class="p-component p-inputtext"
               (input)="onGlobalFilter(dt, $event)" />
      </p-iconfield>
    </div>
  </ng-template>

  <ng-template pTemplate="header">
    <tr>
      <th style="width: 4rem">
        <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
      </th>
      <th>Nom</th>
      <th>Email</th>
      <th>Rôle</th>
      <th>Actions</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-user>
    <tr>
      <td>
        <p-tableCheckbox [value]="user"></p-tableCheckbox>
      </td>
      <td>{{ user.name }}</td>
      <td>{{ user.email }}</td>
      <td>
        <p-tag [value]="user.role" [severity]="getSeverity(user.role)"></p-tag>
      </td>
      <td>
        <div class="flex gap-2">
          <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-outlined p-button-success mr-2"
                  (click)="editUser(user)"></button>
          <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-outlined p-button-danger"
                  (click)="deleteUser(user)"></button>
        </div>
      </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="loadingbody" let-rowIndex>
    <tr>
      <td><p-skeleton size="2rem" shape="circle"></p-skeleton></td>
      <td><p-skeleton height="2rem"></p-skeleton></td>
      <td><p-skeleton height="2rem"></p-skeleton></td>
      <td><p-skeleton height="2rem"></p-skeleton></td>
      <td class="text-center"><p-skeleton size="2rem" shape="circle"></p-skeleton></td>
    </tr>
  </ng-template>
</p-table>

<!-- User Dialog -->
<p-dialog [(visible)]="userDialog" [style]="{width: '450px'}" header="Détails Utilisateur" [modal]="true" 
          class="p-fluid" [closable]="false">
  <ng-template pTemplate="content">
    <div class="field">
      <label for="name" class="block font-bold mb-3">Nom</label>
      <input pInputText id="name" type="text" [(ngModel)]="user.name" class="p-inputtext-fluid" 
             [ngClass]="{'ng-invalid': submitted && !user.name}" />
      <small *ngIf="submitted && !user.name" class="p-error">Le nom est requis.</small>
    </div>
    
    <div class="field">
      <label for="email" class="block font-bold mb-3">Email</label>
      <input pInputText id="email" type="text" [(ngModel)]="user.email" class="p-inputtext-fluid" 
             [ngClass]="{'ng-invalid': submitted && !user.email}" />
      <small *ngIf="submitted && !user.email" class="p-error">L'email est requis.</small>
    </div>
    
    <div class="field">
      <label for="role" class="block font-bold mb-3">Rôle</label>
      <p-select id="role" [options]="roles" optionLabel="label" optionValue="value" [(ngModel)]="user.role"
                placeholder="Sélectionnez un rôle" class="p-inputtext-fluid">
      </p-select>
    </div>
  </ng-template>
  
  <ng-template pTemplate="footer">
    <button pButton pRipple label="Annuler" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
    <button pButton pRipple label="Sauvegarder" icon="pi pi-check" class="p-button-text" (click)="saveUser()"></button>
  </ng-template>
</p-dialog>

